<?xml version="1.0" encoding="UTF-8"?>
<flow xmlns="http://www.springframework.org/schema/webflow"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/webflow
        				http://www.springframework.org/schema/webflow/spring-webflow-2.0.xsd"
	start-state="testRecord"
	parent="navigation">
	
    <action-state id="testRecord">
        <on-entry>
            <evaluate expression="jVoiceArchRecord" result="flowScope.testRecord"/>
            
            <!-- Se setean los atributos del record -->
<!--             <set name="flowScope.testRecord.beep" value="true" /> -->
<!--             <set name="flowScope.testRecord.dtmfterm" value="true" /> -->
<!--             <set name="flowScope.testRecord.maxtime" value="'3s'" /> -->
<!--             <set name="flowScope.testRecord.finalsilence" value="'2s'" /> -->
<!--             <set name="flowScope.testRecord.fileName" value="'transactionNameRec.wav'" /> -->
<!--             <set name="flowScope.testRecord.keep" value="true" /> -->

            <evaluate expression="jVoiceArchAudioItem" result="flowScope.audioItemRecord" />
            <set name="flowScope.audioItemRecord.wording" value="locutionProvider.getWording(T(com.vectorsf.jvoiceframework.testapp.locution.Record).GET_NAME)" />     
            <evaluate expression="flowScope.testRecord.audioItems.add(flowScope.audioItemRecord)"/>

            <!-- Se aÃ±aden los eventos a controlar -->
            <evaluate expression="flowScope.testRecord.events.add(T(com.vectorsf.jvoiceframework.core.bean.Record).RECORDED_EVENT)"/>
             <evaluate expression="flowScope.testRecord.events.add(T(com.vectorsf.jvoiceframework.core.bean.Record).HANGUP_EVENT)"/>
             <evaluate expression="flowScope.testRecord.events.add(T(com.vectorsf.jvoiceframework.core.bean.Record).ERROR_EVENT)"/>

            <!-- Se setean otras propiedades no contempladas en los atributos. -->
            <!-- <evaluate expression="flowScope.testRecord.properties.put('new.property','15s')"/>-->                                              
        </on-entry>

        <evaluate expression="flowProcessor.process(flowScope.testRecord)"/>
            
        <transition to="render" />
    </action-state>
	
	<view-state id="render" view="#{flowProcessor.getRenderer().getView()}" model="lastRecordResult">
		<transition on="error" to="error"/>
		<transition on="recorded" to="thanksOutput">
		    <evaluate expression="recordingService.saveRecording(requestParameters.temprecording, flowScope.testRecord.fileName)"/>      
		</transition>
		<transition on="hangup" to="hangup"/>
	</view-state>
	
	<action-state id="thanksOutput">
        <on-entry>
            <evaluate expression="jVoiceArchAudioItem" result="flowScope.thanksAudioItem" />          
            <set name="flowScope.thanksAudioItem.wording" value="locutionProvider.getWording(T(com.vectorsf.jvoiceframework.testapp.locution.Record).THANKS)"/> 

            <evaluate expression="jVoiceArchAudioItem" result="flowScope.recordEventAudioItem" /> 
            <evaluate expression="jVoiceArchWording" result="flowScope.recordEventAudioItem.wording" />                     
            <set name="flowScope.recordEventAudioItem.wording.text" value="lastRecordResult.event"/> 

            <evaluate expression="jVoiceArchAudioItem" result="flowScope.recordDurationAudioItem" /> 
            <evaluate expression="jVoiceArchWording" result="flowScope.recordDurationAudioItem.wording" />                     
            <set name="flowScope.recordDurationAudioItem.wording.text" value="lastRecordResult.duration"/> 

            <evaluate expression="jVoiceArchAudioItem" result="flowScope.recordSizeAudioItem" /> 
            <evaluate expression="jVoiceArchWording" result="flowScope.recordSizeAudioItem.wording" />                     
            <set name="flowScope.recordSizeAudioItem.wording.text" value="lastRecordResult.size"/> 

            <evaluate expression="jVoiceArchAudioItem" result="flowScope.recordTermcharAudioItem" /> 
            <evaluate expression="jVoiceArchWording" result="flowScope.recordTermcharAudioItem.wording" />                     
            <set name="flowScope.recordTermcharAudioItem.wording.text" value="lastRecordResult.termchar"/> 

            <evaluate expression="jVoiceArchAudioItem" result="flowScope.recordMaxtimeAudioItem" /> 
            <evaluate expression="jVoiceArchWording" result="flowScope.recordMaxtimeAudioItem.wording" />                     
            <set name="flowScope.recordMaxtimeAudioItem.wording.text" value="lastRecordResult.maxtime"/> 

            <evaluate expression="jVoiceArchOutput" result="flowScope.thanksOutput"></evaluate>   
            <evaluate expression="flowScope.thanksOutput.audioItems.add(flowScope.thanksAudioItem)"/> 
            <evaluate expression="flowScope.thanksOutput.audioItems.add(flowScope.recordEventAudioItem)"/> 
            <evaluate expression="flowScope.thanksOutput.audioItems.add(flowScope.recordDurationAudioItem)"/> 
            <evaluate expression="flowScope.thanksOutput.audioItems.add(flowScope.recordSizeAudioItem)"/> 
            <evaluate expression="flowScope.thanksOutput.audioItems.add(flowScope.recordTermcharAudioItem)"/> 
            <evaluate expression="flowScope.thanksOutput.audioItems.add(flowScope.recordMaxtimeAudioItem)"/> 
        </on-entry>

        <evaluate expression="flowProcessor.process(flowScope.thanksOutput)"/>        
        
        <transition on="" to="endRecord" />
	
	</action-state>
		
	<view-state id="hangup" view="flowRedirect:hangup"/>
	
	<end-state id="endRecord"/>
	
</flow>