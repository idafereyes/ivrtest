<?xml version="1.0" encoding="UTF-8"?>
<flow 	xmlns="http://www.springframework.org/schema/webflow"
		xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
		xsi:schemaLocation="http://www.springframework.org/schema/webflow 
							http://www.springframework.org/schema/webflow/spring-webflow-2.0.xsd"
		start-state="setup">

    <!-- Creamos en el lastInputResult con scope conversacion para que se mantenga en todos los flujos -->
    <on-start>
        <evaluate expression="lastInputResult" result="conversationScope.lastInputResult"></evaluate>
    </on-start>

    <!-- 	Inicialización de la configuración por defecto de la aplicación. 
    		Se hace manualmente mientras no tengamos un mecanismo mejor para este tipo de configuración -->
    		
	<subflow-state id="setup" subflow="setup">
		<transition  to="wellcome"/>
	</subflow-state>
	
	<subflow-state id="wellcome" subflow="wellcome">
		<transition  to="menu"/>
	</subflow-state>

	<subflow-state id="menu" subflow="main-menu">
		<transition to="menuDecision">
			<set name="flowScope.menuOption" value="currentEvent.attributes.menuOption"></set> <!--  PUFF -->
		</transition>
	</subflow-state>
	
	<action-state id="menuDecision">	
		<evaluate expression="flowScope.menuOption"></evaluate>
		<transition on="0" to="error"/>
	    <transition on="1" to="accounts"/>
	    <transition on="2" to="transactions"/>
	    <transition on="3" to="transfer"/>
	    <transition on="4" to="transfer"/>
	    <transition on="5" to="transfer"/>
	    <transition on="6" to="transfer"/>
	    <transition on="7" to="error"/>
	    <transition on="8" to="noMenuBack"/>
	    <transition on="9" to="noMainMenu"/>
	    <transition to="wellcome"/>
	</action-state>
	
	<subflow-state id="accounts" subflow="accounts">	
		<transition on="menuBack" to="menu"/> <!-- Webflow coge el id del estado fin como un evento a la vuelta. "menuBack es el id del estado que se usa para ir hacia atrás en el menú en el superflujo navigation" -->
		<transition to="end"/>
	</subflow-state>
	

	<action-state id="noMenuBack">   		
		<on-entry>
			<evaluate expression="audioItem" result="flowScope.noMenuBackAudioItem" /> 			
  			<set name="flowScope.noMenuBackAudioItem.wording" value="locutionProvider.getWording(T(com.vectorsf.jvoiceframework.testapp.locution.Menu).NO_MENU_BACK)"/> 

			<evaluate expression="output" result="flowScope.noMenuBackOutput"/>	
			<evaluate expression="flowScope.noMenuBackOutput.audioItems.add(flowScope.noMenuBackAudioItem)"/> 			 
		</on-entry>

		<evaluate expression="flowProcessor.process(flowScope.noMenuBackOutput)"/> 		
		<transition to="menu" />
	</action-state>
	
	<action-state id="noMainMenu">   		
		<on-entry>
			<evaluate expression="audioItem" result="flowScope.noMainMenuAudioItem" /> 			
  			<set name="flowScope.noMainMenuAudioItem.wording" value="locutionProvider.getWording(T(com.vectorsf.jvoiceframework.testapp.locution.Menu).NO_MAIN_MENU)"/> 

			<evaluate expression="output" result="flowScope.noMainMenuOutput"/>
			<evaluate expression="flowScope.noMainMenuOutput.audioItems.add(flowScope.noMainMenuAudioItem)"/> 			 
		</on-entry>

		<evaluate expression="flowProcessor.process(flowScope.noMainMenuOutput)"/> 		
		<transition to="menu" />
	</action-state>

	<end-state id="end"/>
	
</flow>
