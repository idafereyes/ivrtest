<?xml version="1.0" encoding="UTF-8"?>
<flow xmlns="http://www.springframework.org/schema/webflow"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/webflow
        				http://www.springframework.org/schema/webflow/spring-webflow-2.0.xsd"
	start-state="wellcomeOutput">

   	<action-state id="wellcomeOutput">   		
		<on-entry>
			<evaluate expression="audioItem" result="flowScope.wellcomeRetailOutputAudioItem" /> 			
            <set name="flowScope.wellcomeRetailOutputAudioItem.src" value="locutionProvider.getAudioSrc(T(com.vectorsf.jvoiceframework.testapp.locution.Wellcome).WELLCOME_RETAIL_SRC)"/> 
  			<set name="flowScope.wellcomeRetailOutputAudioItem.wording" value="locutionProvider.getWording(T(com.vectorsf.jvoiceframework.testapp.locution.Wellcome).WELLCOME_RETAIL)"/> 
			<set name="flowScope.wellcomeRetailOutputAudioItem.condition" value="ctiData.getApplication().equals(T(com.vectorsf.jvoiceframework.testapp.model.CTIDataVector).APPLICATION_RETAIL)"/>  

			<evaluate expression="audioItem" result="flowScope.wellcomePymeRetailOutputAudioItem" />
            <set name="flowScope.wellcomePymeRetailOutputAudioItem.src" value="locutionProvider.getAudioSrc(T(com.vectorsf.jvoiceframework.testapp.locution.Wellcome).WELLCOME_PYME_RETAIL_SRC)"/> 
			<set name="flowScope.wellcomePymeRetailOutputAudioItem.wording" value="locutionProvider.getWording(T(com.vectorsf.jvoiceframework.testapp.locution.Wellcome).WELLCOME_PYME_RETAIL)"/> 
			<set name="flowScope.wellcomePymeRetailOutputAudioItem.condition" value="ctiData.getApplication().equals(T(com.vectorsf.jvoiceframework.testapp.model.CTIDataVector).APPLICATION_PYME_RETAIL)"/>  

			<evaluate expression="audioItem" result="flowScope.wellcomeULineRetailOutputAudioItem" />
            <set name="flowScope.wellcomeULineRetailOutputAudioItem.src" value="locutionProvider.getAudioSrc(T(com.vectorsf.jvoiceframework.testapp.locution.Wellcome).WELLCOME_ULINE_RETAIL_SRC)"/> 
			<set name="flowScope.wellcomeULineRetailOutputAudioItem.wording" value="locutionProvider.getWording(T(com.vectorsf.jvoiceframework.testapp.locution.Wellcome).WELLCOME_ULINE_RETAIL)"/> 
			<set name="flowScope.wellcomeULineRetailOutputAudioItem.condition" value="ctiData.getApplication().equals(T(com.vectorsf.jvoiceframework.testapp.model.CTIDataVector).APPLICATION_ULINE_RETAIL)"/>

			<evaluate expression="output" result="flowScope.wellcomeOutput"></evaluate>	
			<evaluate expression="flowScope.wellcomeOutput.audioItems.add(flowScope.wellcomeRetailOutputAudioItem)"/> 
			<evaluate expression="flowScope.wellcomeOutput.audioItems.add(flowScope.wellcomePymeRetailOutputAudioItem)"/> 
			<evaluate expression="flowScope.wellcomeOutput.audioItems.add(flowScope.wellcomeULineRetailOutputAudioItem)"/>
			<set name="flowScope.wellcomeOutput.flush" value="true" /> 			 
		</on-entry>

		<evaluate expression="flowProcessor.process(flowScope.wellcomeOutput)"/> 		
		<transition on="" to="render" />
   	</action-state>

    <view-state id="render" view="#{flowProcessor.getRenderer().getView()}">
       <transition to="promotion"/>
    </view-state>

	<subflow-state id="promotion" subflow="promotion">
		<transition  to="setLanguage"/>
	</subflow-state>

	<action-state id="setLanguage">
		<on-entry>
			<evaluate expression="input" result="flowScope.setLanguageInput" />
			<set name="flowScope.setLanguageInput.name" value="'WELLCOME'" />
			<set name="flowScope.setLanguageInput.bargein" value="false" />
			<set name="flowScope.setLanguageInput.maxAttempts" value="1" />

			<evaluate expression="grammar" result="flowScope.grammar1" />
			<set name="flowScope.grammar1.src" value="'builtin:dtmf/digits?length=1'"/>
			<set name="flowScope.grammar1.mode" value="'dtmf'"/>
			<evaluate expression="flowScope.setLanguageInput.grammars.add(flowScope.grammar1)" />

			<evaluate expression="audioItem" result="flowScope.setLanguageAudioItem" />
			<set name="flowScope.setLanguageAudioItem.src" value="locutionProvider.getAudioSrc(T(com.vectorsf.jvoiceframework.testapp.locution.Language).LANGUAGE_SELECTION_SRC, new java.util.Locale('en','US'))"/> 
            <set name="flowScope.setLanguageAudioItem.wording" value="locutionProvider.getWording(T(com.vectorsf.jvoiceframework.testapp.locution.Language).LANGUAGE_SELECTION, new java.util.Locale('en','US'))"/> 
			<evaluate expression="flowScope.setLanguageInput.mainAudios.add(flowScope.setLanguageAudioItem)" />
			
			<evaluate expression="flowScope.setLanguageInput.events.add('maxattempts')" />

		</on-entry>

		<evaluate expression="flowProcessor.process(flowScope.setLanguageInput)" />

		<transition to="render2"></transition>
	</action-state>


	<view-state id="render2" view="#{flowProcessor.getRenderer().getView()}" model="lastInputResult">
		<transition on="match" to="setLanguageInputCheck"/>
		<transition to="end"/>
	</view-state>
	
	<action-state id="setLanguageInputCheck">
		<evaluate expression="lastInputResult.interpretation"/>
		<transition on="1" to="end">
			<evaluate expression="jvoiceUser.setLocale(new java.util.Locale('en','US'))" /> 
		</transition>
		<transition to="end"/>
	</action-state>

	<end-state id="end"/>
</flow>
