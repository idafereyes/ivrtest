<?xml version="1.0" encoding="UTF-8"?>
<flow xmlns="http://www.springframework.org/schema/webflow"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/webflow
        				http://www.springframework.org/schema/webflow/spring-webflow-2.0.xsd"
	start-state="wellcomeOutput">

   	<action-state id="wellcomeOutput">   		
		<on-entry>
			<evaluate expression="audioItem" result="flowScope.wellcomeRetailOutputAudioItem" /> 			
  			<set name="flowScope.wellcomeRetailOutputAudioItem.wording" value="locutionProvider.getLocution(T(com.vectorsf.jvoiceframework.testapp.locution.Wellcome).WELLCOME_RETAIL)"/> 
			<set name="flowScope.wellcomeRetailOutputAudioItem.condition" value="ctiData.getApplication().equals(T(com.vectorsf.jvoiceframework.testapp.bean.CTIDataVector).APPLICATION_RETAIL)"/>  

			<evaluate expression="audioItem" result="flowScope.wellcomePymeRetailOutputAudioItem" />
			<set name="flowScope.wellcomePymeRetailOutputAudioItem.wording" value="locutionProvider.getLocution(T(com.vectorsf.jvoiceframework.testapp.locution.Wellcome).WELLCOME_PYME_RETAIL)"/> 
			<set name="flowScope.wellcomePymeRetailOutputAudioItem.condition" value="ctiData.getApplication().equals(T(com.vectorsf.jvoiceframework.testapp.bean.CTIDataVector).APPLICATION_PYME_RETAIL)"/>  

			<evaluate expression="audioItem" result="flowScope.wellcomeULineRetailOutputAudioItem" />
			<set name="flowScope.wellcomeULineRetailOutputAudioItem.wording" value="locutionProvider.getLocution(T(com.vectorsf.jvoiceframework.testapp.locution.Wellcome).WELLCOME_ULINE_RETAIL)"/> 
			<set name="flowScope.wellcomeULineRetailOutputAudioItem.condition" value="ctiData.getApplication().equals(T(com.vectorsf.jvoiceframework.testapp.bean.CTIDataVector).APPLICATION_ULINE_RETAIL)"/>

			<evaluate expression="output" result="flowScope.wellcomeOutput"></evaluate>	
			<evaluate expression="flowScope.wellcomeOutput.audioItems.add(flowScope.wellcomeRetailOutputAudioItem)"/> 
			<evaluate expression="flowScope.wellcomeOutput.audioItems.add(flowScope.wellcomePymeRetailOutputAudioItem)"/> 
			<evaluate expression="flowScope.wellcomeOutput.audioItems.add(flowScope.wellcomeULineRetailOutputAudioItem)"/> 			 
		</on-entry>

		<evaluate expression="flowProcessor.process(flowScope.wellcomeOutput)"/> 		
		<transition on="" to="promotion" />
	</action-state>


	<subflow-state id="promotion" subflow="promotion">
		<transition  to="setLanguage"/>
	</subflow-state>

	<action-state id="setLanguage">
		<on-entry>
			<evaluate expression="input" result="flowScope.setLanguageInput" />
			<set name="flowScope.setLanguageInput.bargein" value="true" />

			<evaluate expression="grammar" result="flowScope.grammar" />
			<set name="flowScope.grammar.type" value="'builtin'"/>
			<set name="flowScope.grammar.src" value="'dtmf/digits?length=1'"/>
			<evaluate expression="flowScope.setLanguageInput.grammars.add(flowScope.grammar)" />

			<evaluate expression="audioItem" result="flowScope.setLanguageAudioItem" />
			<set name="flowScope.setLanguageAudioItem.wording" value="locutionProvider.getLocution(T(com.vectorsf.jvoiceframework.testapp.locution.Language).LANGUAGE_SELECTION, new java.util.Locale('en','US'))"/> 
			<evaluate expression="flowScope.setLanguageInput.mainAudios.add(flowScope.setLanguageAudioItem)" />

		</on-entry>

		<evaluate expression="flowProcessor.process(flowScope.setLanguageInput)" />

		<transition to="render"></transition>
	</action-state>


	<view-state id="render" view="render">
		<on-entry>
			<evaluate expression="lastInputResult" result="flowScope.lastInputResult"/>
		</on-entry>
		<transition on="match" to="setLanguageInputCheck">
			<set name="flowScope.lastInputResult.interpretation" value="requestParameters.interpretation"/>			
		</transition>
		
		<transition  to="end"/>
	</view-state>
	
	<action-state id="setLanguageInputCheck">
		<evaluate expression="flowScope.lastInputResult.interpretation"/>
		<transition on="1" to="end">
			<evaluate expression="userLocale.setLocale(new java.util.Locale('en','US'))" /> <!-- OTRO ESTADO??? -->
		</transition>
		<transition to="end"/>
	</action-state>
	
	
	
	
	<end-state id="end"/>	
</flow>